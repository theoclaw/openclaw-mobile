name: Build Release APK

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'Version suffix (e.g., beta1, rc1)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package_variant: [ apt-android-7 ]

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Download bootstrap archives
        run: |
          echo "Downloading bootstrap archives from botdrop-packages latest release..."
          cd app/src/main/cpp
          url="https://github.com/zhixianio/botdrop-packages/releases/latest/download/bootstrap-aarch64.zip"
          echo "Downloading ${url}..."
          curl -fsSL -L -o "bootstrap-aarch64.zip" "$url"
          echo "Downloaded bootstrap-aarch64.zip ($(stat --printf='%s' bootstrap-aarch64.zip) bytes)"

      - name: Decode signing key
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        run: |
          echo "$SIGNING_KEY" | base64 -d > app/release-key.jks

      - name: Build Release APKs
        shell: bash {0}
        env:
          PACKAGE_VARIANT: ${{ matrix.package_variant }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
        run: |
          set -e

          echo "Setting build variables..."

          # Get version info
          CURRENT_VERSION_NAME_REGEX='\s+versionName "([^"]+)"$'
          CURRENT_VERSION_NAME="$(grep -m 1 -E "$CURRENT_VERSION_NAME_REGEX" ./app/build.gradle | sed -r "s/$CURRENT_VERSION_NAME_REGEX/\1/")"

          # Add version suffix if provided
          VERSION_SUFFIX="${{ github.event.inputs.version_suffix }}"
          if [ -n "$VERSION_SUFFIX" ]; then
            RELEASE_VERSION_NAME="v${CURRENT_VERSION_NAME}-${VERSION_SUFFIX}+${GITHUB_SHA:0:7}"
          else
            RELEASE_VERSION_NAME="v${CURRENT_VERSION_NAME}+${GITHUB_SHA:0:7}"
          fi

          APK_DIR_PATH="./app/build/outputs/apk/release"
          APK_VERSION_TAG="$RELEASE_VERSION_NAME-${{ env.PACKAGE_VARIANT }}-release"
          APK_BASENAME_PREFIX="botdrop-app_$APK_VERSION_TAG"

          echo "APK_DIR_PATH=$APK_DIR_PATH" >> $GITHUB_ENV
          echo "APK_VERSION_TAG=$APK_VERSION_TAG" >> $GITHUB_ENV
          echo "APK_BASENAME_PREFIX=$APK_BASENAME_PREFIX" >> $GITHUB_ENV
          echo "RELEASE_VERSION_NAME=$RELEASE_VERSION_NAME" >> $GITHUB_ENV

          echo "Building Release APKs for version $RELEASE_VERSION_NAME..."

          export TERMUX_APP_VERSION_NAME="${RELEASE_VERSION_NAME/v/}"
          export TERMUX_APK_VERSION_TAG="$APK_VERSION_TAG"
          export TERMUX_PACKAGE_VARIANT="${{ env.PACKAGE_VARIANT }}"

          # Build release APK with signing
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/app/release-key.jks \
            -Pandroid.injected.signing.store.password="$SIGNING_KEY_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$SIGNING_KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$SIGNING_KEY_PASSWORD"

          echo "Validating APKs..."
          ls -la "$APK_DIR_PATH/"

          echo "Generating sha256sums..."
          cd "$APK_DIR_PATH"
          sha256sum *.apk > sha256sums.txt
          cat sha256sums.txt

      - name: Upload Universal APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_BASENAME_PREFIX }}_universal
          path: |
            ${{ env.APK_DIR_PATH }}/*universal*.apk

      - name: Upload arm64-v8a APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_BASENAME_PREFIX }}_arm64-v8a
          path: |
            ${{ env.APK_DIR_PATH }}/*arm64-v8a*.apk

      - name: Upload SHA256 checksums
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_BASENAME_PREFIX }}_sha256sums
          path: |
            ${{ env.APK_DIR_PATH }}/sha256sums.txt

      - name: Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.APK_DIR_PATH }}/*.apk
            ${{ env.APK_DIR_PATH }}/sha256sums.txt
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
